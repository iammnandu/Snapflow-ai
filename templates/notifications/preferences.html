<!-- templates/notifications/preferences.html -->
{% extends 'notifications/base_notifications.html' %}
{% load notification_filters %}

{% block notification_content %}
<div class="card">
  <h5 class="card-header">
    Notification Preferences
  </h5>

  <form method="post" class="notification-preferences-form">
    {% csrf_token %}
    
    <div class="card-body">
      <div class="alert alert-info mb-4">
        <div class="d-flex">
          <i class="bx bx-info-circle bx-sm me-3 mt-1"></i>
          <div>
            <p class="mb-0">We need permission from your browser to show notifications.</p>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2 notificationRequest">
              <i class="bx bx-bell me-1"></i> Request Permission
            </button>
            <div class="error text-danger mt-2"></div>
          </div>
        </div>
      </div>
      
      <!-- Table Layout for Notification Types -->
      <div class="table-responsive mb-4">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th width="50%" class="text-nowrap">NOTIFICATION TYPE</th>
              <th class="text-nowrap text-center">
                <i class="bx bx-envelope me-1"></i> EMAIL
              </th>
              <th class="text-nowrap text-center">
                <i class="bx bx-bell me-1"></i> IN-APP
              </th>
            </tr>
          </thead>
          <tbody>
            {% for email_field in form.email_fields %}
              {% with app_field=form.app_fields|get_by_index:forloop.counter0 %}
                <tr>
                  <td class="text-nowrap">
                    <label class="form-check-label fw-medium" for="{{ email_field.id_for_label }}">
                      {{ email_field.label }}
                    </label>
                  </td>
                  <td>
                    <div class="form-check d-flex justify-content-center">
                      {{ email_field }}
                    </div>
                  </td>
                  <td>
                    <div class="form-check d-flex justify-content-center">
                      {{ app_field }}
                    </div>
                  </td>
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Notification Timing Preferences -->
      <div class="card mb-4">
        <div class="card-body">
          <h6 class="fw-bold mb-3">When should we send you notifications?</h6>
          <div class="row">
            <div class="col-md-6">
              <select id="sendNotification" class="form-select" name="sendNotification">
                <option selected>Only when I'm online</option>
                <option>Anytime</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Digest Preferences -->
      <div class="card">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Digest Preferences</h6>
          <p class="text-muted mb-3">Choose how you want to receive notification summaries</p>
          
          {% for field in form.digest_fields %}
            <div class="form-check mb-3">
              {{ field }}
              <label for="{{ field.id_for_label }}" class="form-check-label">
                {{ field.label }}
              </label>
              {% if field.help_text %}
                <small class="text-muted d-block mt-1">{{ field.help_text }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Form Actions -->
    <div class="card-footer">
      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'notifications:list' %}" class="btn btn-outline-secondary">
          <i class="bx bx-x me-1"></i> Discard
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="bx bx-save me-1"></i> Save changes
        </button>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle browser notification permission
  const requestBtn = document.querySelector('.notificationRequest');
  const errorDiv = document.querySelector('.error');
  
  if (requestBtn) {
    requestBtn.addEventListener('click', function() {
      if (!('Notification' in window)) {
        errorDiv.textContent = 'This browser does not support desktop notifications';
        return;
      }
      
      Notification.requestPermission()
        .then(function(permission) {
          if (permission === 'granted') {
            requestBtn.textContent = 'Permission Granted';
            requestBtn.classList.remove('btn-outline-primary');
            requestBtn.classList.add('btn-success');
            requestBtn.disabled = true;
          } else {
            errorDiv.textContent = 'Notification permission was denied';
          }
        });
    });
    
    // Check current permission status on load
    if ('Notification' in window && Notification.permission === 'granted') {
      requestBtn.textContent = 'Permission Granted';
      requestBtn.classList.remove('btn-outline-primary');
      requestBtn.classList.add('btn-success');
      requestBtn.disabled = true;
    }
  }
});
</script>
{% endblock %}