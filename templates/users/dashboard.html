{% extends "users/base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block body_block %}
<div class="space-y-6">
    <!-- User Info Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center space-x-4">
            <img src="{{ user.avatar.url|default:'/static/default-avatar.png' }}" 
                 alt="{{ user.get_full_name }}" 
                 class="h-16 w-16 rounded-full">
            <div>
                <h1 class="text-2xl font-bold">{{ user.get_full_name }}</h1>
                <p class="text-gray-600">{{ user.get_role_display }}</p>
            </div>
            
            <!-- Quick Actions -->
            <div class="ml-auto flex space-x-2">
                {% if user.role == 'ORGANIZER' %}
                <a href="{% url 'events:event_create' %}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Create Event
                </a>
                {% endif %}
                <a href="{% url 'users:profile' %}" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">
                    Edit Profile
                </a>
            </div>
        </div>
    </div>

    <!-- Join Event Section (Photographers and Participants) -->
    {% if user.role == 'PHOTOGRAPHER' or user.role == 'PARTICIPANT' %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Join an Event</h2>
        <form method="post" action="{% url 'events:request_access' %}" class="flex flex-wrap gap-2">
            {% csrf_token %}
            <div class="flex-grow">
                <input type="text" name="event_code" placeholder="Enter 6-digit event code" maxlength="6"
                        class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                Request Access
            </button>
        </form>
    </div>
    {% endif %}

    {% if user.role == 'ORGANIZER' %}
    <!-- Organizer Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-blue-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Total Events</h3>
            <p class="text-3xl font-bold">{{ events.count }}</p>
        </div>
        <div class="bg-green-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Total Participants</h3>
            <p class="text-3xl font-bold">{{ total_participants }}</p>
        </div>
        <div class="bg-purple-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Total Photographers</h3>
            <p class="text-3xl font-bold">{{ total_photographers }}</p>
        </div>
    </div>

    <!-- Pending Requests -->
    {% if pending_requests %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Pending Access Requests</h2>
        <div class="space-y-4">
            {% for request in pending_requests %}
            <div class="border rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold">{{ request.user.get_full_name }}</p>
                        <p class="text-sm text-gray-600">{{ request.get_request_type_display }}</p>
                        <p class="text-sm text-gray-500">{{ request.created_at|date }}</p>
                        {% if request.message %}
                        <p class="text-sm mt-2">{{ request.message }}</p>
                        {% endif %}
                    </div>
                    <div class="space-x-2">
                        <button onclick="handleRequest('{{ request.id }}', 'approve')"
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            Approve
                        </button>
                        <button onclick="handleRequest('{{ request.id }}', 'reject')"
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Events List -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Your Events</h2>
        {% if events %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for event in events %}
            <div class="border rounded-lg overflow-hidden">
                {% if event.cover_image %}
                <img src="{{ event.cover_image.url }}" alt="{{ event.title }}" class="w-full h-40 object-cover">
                {% else %}
                <div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500">No Cover Image</span>
                </div>
                {% endif %}
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">{{ event.title }}</h3>
                        <span class="px-2 py-1 text-xs rounded-full {% if event.status == 'ACTIVE' %}bg-green-100 text-green-800{% elif event.status == 'DRAFT' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ event.get_status_display }}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">{{ event.start_date|date }}</p>
                    <p class="text-sm text-gray-500">Code: <span class="font-mono">{{ event.event_code }}</span></p>
                    <div class="mt-3 flex items-center justify-between">
                        <div class="flex space-x-2">
                            <span class="text-xs text-gray-500">{{ event.participants.count }} participants</span>
                            <span class="text-xs text-gray-500">{{ event.crew_members.count }} crew</span>
                        </div>
                        <a href="{% url 'events:event_dashboard' event.slug %}"
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            Manage Event →
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500">You haven't created any events yet.</p>
            <a href="{% url 'events:event_create' %}" class="mt-4 inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Create Your First Event
            </a>
        </div>
        {% endif %}
    </div>

    {% elif user.role == 'PHOTOGRAPHER' %}
    <!-- Photographer Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-blue-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Total Events</h3>
            <p class="text-3xl font-bold">{{ crew_memberships.count }}</p>
        </div>
        <div class="bg-green-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Total Photos</h3>
            <p class="text-3xl font-bold">{{ total_photos|default:"0" }}</p>
        </div>
        <div class="bg-purple-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Upcoming Events</h3>
            <p class="text-3xl font-bold">{{ upcoming_events|default:"0" }}</p>
        </div>
    </div>

    <!-- Equipment Status -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Equipment Status</h2>
        {% if photographer_equipment %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for crew in crew_memberships %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">{{ crew.event.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ crew.get_role_display }}</td>
                        <td class="px-6 py-4">{{ crew.equipment|truncatechars:50|default:"Not specified" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="{% url 'events:equipment_config' crew.event.slug %}" 
                               class="text-indigo-600 hover:text-indigo-900">Update</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">No equipment configured yet.</p>
        {% endif %}
    </div>

    <!-- Event Assignments -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Your Event Assignments</h2>
        {% if crew_memberships %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for crew in crew_memberships %}
            <div class="border rounded-lg overflow-hidden">
                {% if crew.event.cover_image %}
                <img src="{{ crew.event.cover_image.url }}" alt="{{ crew.event.title }}" class="w-full h-40 object-cover">
                {% else %}
                <div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500">No Cover Image</span>
                </div>
                {% endif %}
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">{{ crew.event.title }}</h3>
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                            {{ crew.get_role_display }}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">{{ crew.event.start_date|date }}</p>
                    <p class="text-sm text-gray-500">{{ crew.assigned_area|default:"No assigned area" }}</p>
                    
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            {% if crew.is_confirmed %}
                            <span class="text-green-600">✓ Confirmed</span>
                            {% else %}
                            <span class="text-yellow-600">⚠ Pending Confirmation</span>
                            {% endif %}
                        </span>
                        <a href="{% url 'events:event_dashboard' crew.event.slug %}"
                          class="text-blue-600 hover:text-blue-800 text-sm">
                            View Event →
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500">You haven't been assigned to any events yet.</p>
            <p class="mt-2 text-sm text-gray-400">Use the event code at the top of this page to join an event.</p>
        </div>
        {% endif %}
    </div>

    {% else %}
    <!-- Participant Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-blue-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Events Joined</h3>
            <p class="text-3xl font-bold">{{ participations.count }}</p>
        </div>
        <div class="bg-green-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Photos of You</h3>
            <p class="text-3xl font-bold">{{ photos_of_user|default:"0" }}</p>
        </div>
        <div class="bg-purple-100 rounded-lg p-6">
            <h3 class="text-lg font-semibold">Privacy Settings</h3>
            <div class="mt-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if user.blur_requested %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                    {% if user.blur_requested %}Blur Requested{% else %}Blur Off{% endif %}
                </span>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if user.remove_requested %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                    {% if user.remove_requested %}Remove Requested{% else %}Remove Off{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Privacy Controls -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Privacy Controls</h2>
        <form method="post" action="{% url 'users:update_privacy' %}" class="space-y-4">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="blur_requested" name="blur_requested" {% if user.blur_requested %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="blur_requested" class="text-sm text-gray-700">Request face blurring in all photos</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="remove_requested" name="remove_requested" {% if user.remove_requested %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="remove_requested" class="text-sm text-gray-700">Request removal from all photos</label>
                </div>
                <div class="flex items-center space-x-2">
                    <select id="image_visibility" name="image_visibility" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="PUBLIC" {% if user.image_visibility == 'PUBLIC' %}selected{% endif %}>Public - Visible to Everyone</option>
                        <option value="PRIVATE" {% if user.image_visibility == 'PRIVATE' %}selected{% endif %}>Private - Visible Only to Me</option>
                        <option value="EVENT_ONLY" {% if user.image_visibility == 'EVENT_ONLY' %}selected{% endif %}>Event Only - Visible to Event Participants</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Update Privacy Settings
            </button>
        </form>
    </div>

    <!-- Events List -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Your Events</h2>
        {% if participations %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for participation in participations %}
            <div class="border rounded-lg overflow-hidden">
                {% if participation.event.cover_image %}
                <img src="{{ participation.event.cover_image.url }}" alt="{{ participation.event.title }}" class="w-full h-40 object-cover">
                {% else %}
                <div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500">No Cover Image</span>
                </div>
                {% endif %}
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold">{{ participation.event.title }}</h3>
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            {{ participation.get_participant_type_display }}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600">{{ participation.event.start_date|date }}</p>
                    
                    {% if participation.registration_code %}
                    <div class="mt-2 p-2 bg-gray-50 rounded text-xs font-mono">
                        Registration: {{ participation.registration_code }}
                    </div>
                    {% endif %}
                    
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            {% if participation.allow_photos %}
                            <span class="text-green-600">✓ Photos allowed</span>
                            {% else %}
                            <span class="text-red-600">⨯ Photos not allowed</span>
                            {% endif %}
                        </span>
                        <a href="{% url 'events:event_gallery' participation.event.slug %}"
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            View Gallery →
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500">You haven't joined any events yet.</p>
            <p class="mt-2 text-sm text-gray-400">Use the event code at the top of this page to join an event.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Access Requests Status (Photographer and Participant only) -->
    {% if user.role != 'ORGANIZER' and user_requests %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Your Access Requests</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Requested</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for request in user_requests %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">{{ request.event.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ request.created_at|date }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if request.status == 'PENDING' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            {% elif request.status == 'APPROVED' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Approved</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Rejected</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
<form id="csrf-form" style="display: none;">
    {% csrf_token %}
</form>
<!-- JavaScript for handling requests -->
<script>
        function handleRequest(requestId, action) {
            fetch(`{% url 'events:handle_access_request' 0 %}`.replace('0', requestId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server returned ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('Request processed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process request. Check console for details.');
            });
        }
</script>
{% endblock %}