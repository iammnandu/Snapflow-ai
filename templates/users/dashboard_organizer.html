{% extends "users/db_base.html" %}
{% load static %}
{% block title %}
<title>SnapFlow : Organizer Dashboard</title>
{% endblock title %}
{% block content %}
<!-- Content wrapper -->
<div class="content-wrapper">
   <!-- Content -->
   <div class="container-xxl flex-grow-1 container-p-y">
      <div class="row">
         <div class="col-12 mb-4 order-0">
            <div class="card">
               <div class="d-flex align-items-end row">
                  <div class="col-sm-7">
                     <div class="card-body">
                        <h5 class="card-title text-primary">Welcome {{ user.username }}! ðŸŽ‰</h5>
                        <p class="mb-4"> You have <span class="fw-bold">{{ pending_requests.count }}</span> pending access requests and <span class="fw-bold">{{ events.count }}</span> total events. </p>
                        <a href="{% url 'events:event_create' %}" class="btn btn-sm btn-primary">Create New Event</a>
                     </div>
                  </div>
                  <div class="col-sm-5 text-center text-sm-left">
                     <div class="card-body pb-0 px-0 px-md-4">
                        <img src="{% static 'users/assets/img/illustrations/man-with-laptop-light.png' %}" height="140" alt="Event Organizer" data-app-dark-img="illustrations/man-with-laptop-dark.png" data-app-light-img="illustrations/man-with-laptop-light.png" />
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="row">
         <!-- Total Photographers Card -->
         <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card">
               <div class="card-body">
                  <div class="card-title d-flex align-items-start justify-content-between">
                     <div class="avatar flex-shrink-0">
                        <img src="{% static 'users/assets/img/icons/unicons/photographer.png' %}" alt="Photographers" class="rounded" />
                     </div>
                     <div class="dropdown">
                        <button class="btn p-0" type="button" id="cardOpt4" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt4">
                           <a class="dropdown-item" href="">View All Photographers</a>
                        </div>
                     </div>
                  </div>
                  <span class="d-block mb-1">Photographers</span>
                  <h3 class="card-title text-nowrap mb-2">{{ total_photographers }}</h3>
                  <small class="text-primary fw-semibold">
                  <i class="bx bx-camera"></i> In your events </small>
               </div>
            </div>
         </div>
         <!-- Total Events Card -->
         <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card">
               <div class="card-body">
                  <div class="card-title d-flex align-items-start justify-content-between">
                     <div class="avatar flex-shrink-0">
                        <img src="{% static 'users/assets/img/icons/unicons/calendar.png' %}" alt="Events" class="rounded" />
                     </div>
                     <div class="dropdown">
                        <button class="btn p-0" type="button" id="cardOpt2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt2">
                           <a class="dropdown-item" href="{% url 'events:event_list' %}">View All Events</a>
                        </div>
                     </div>
                  </div>
                  <span class="d-block mb-1">Total Events</span>
                  <h3 class="card-title text-nowrap mb-2">{{ events.count }}</h3>
                  <small class="text-success fw-semibold">
                  <i class="bx bx-calendar-check"></i> {{ upcoming_events.count }} upcoming </small>
               </div>
            </div>
         </div>
         <!-- Pending Requests Card -->
         <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card">
               <div class="card-body">
                  <div class="card-title d-flex align-items-start justify-content-between">
                     <div class="avatar flex-shrink-0">
                        <img src="{% static 'users/assets/img/icons/unicons/request.png' %}" alt="Requests" class="rounded" />
                     </div>
                     <div class="dropdown">
                        <button class="btn p-0" type="button" id="cardOpt1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="cardOpt1">
                           <a class="dropdown-item" href="{% url 'events:access_requests' %}">View All Requests</a>
                        </div>
                     </div>
                  </div>
                  <span class="fw-semibold d-block mb-1">Pending Requests</span>
                  <h3 class="card-title mb-2">{{ pending_requests.count }}</h3>
                  <small class="text-warning fw-semibold">
                  <i class="bx bx-timer"></i> Needs review </small>
               </div>
            </div>
         </div>
         <!-- Total Participants Card -->
         <div class="col-lg-3 col-md-6 col-6 mb-4">
            <div class="card">
               <div class="card-body">
                  <div class="card-title d-flex align-items-start justify-content-between">
                     <div class="avatar flex-shrink-0">
                        <img src="{% static 'users/assets/img/icons/unicons/teamwork.png' %}" alt="Participants" class="rounded" />
                     </div>
                     <div class="dropdown">
                        <button class="btn p-0" type="button" id="cardOpt7" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="cardOpt7">
                           <a class="dropdown-item" href="">View All Participants</a>
                        </div>
                     </div>
                  </div>
                  <span>Recent Participants</span>
                  <h3 class="card-title text-nowrap mb-1">{{ total_participants }}</h3>
                  <small class="text-success fw-semibold">
                  <i class="bx bx-user-plus"></i> New registrations </small>
               </div>
            </div>
         </div>
      </div>
      <!-- Event Statistics and Quote Section -->
      <div class="row">
         <!-- Event Statistics Chart -->
         <div class="col-12 col-lg-8 mb-4">
            <div class="card">
               <div class="row row-bordered g-0">
                  <div class="col-md-8">
                     <h5 class="card-header m-0 me-2 pb-3">Event Statistics</h5>
                     <div id="eventsActivityChart" class="px-2"></div>
                  </div>
                  <div class="col-md-4">
                     <div class="card-body">
                        <div class="text-center">
                           <div class="dropdown">
                              <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="eventReportId" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              {{ current_year }}
                              </button>
                              <div class="dropdown-menu dropdown-menu-end" aria-labelledby="eventReportId"> {% for year in available_years %} <a class="dropdown-item" href="javascript:void(0);" onclick="updateChartYear({{ year }})">{{ year }}</a> {% endfor %} </div>
                           </div>
                        </div>
                     </div>
                     <div id="eventGrowthChart"></div>
                     <div class="text-center fw-semibold pt-3 mb-2">{{ event_growth_percentage }}% Event Growth</div>
                     <div class="d-flex px-xxl-4 px-lg-2 p-4 gap-xxl-3 gap-lg-1 gap-3 justify-content-between">
                        <div class="d-flex">
                           <div class="me-2">
                              <span class="badge bg-label-primary p-2">
                              <i class="bx bx-calendar text-primary"></i>
                              </span>
                           </div>
                           <div class="d-flex flex-column">
                              <small>{{ current_year }}</small>
                              <h6 class="mb-0">{{ current_year_events }}</h6>
                           </div>
                        </div>
                        <div class="d-flex">
                           <div class="me-2">
                              <span class="badge bg-label-info p-2">
                              <i class="bx bx-calendar-check text-info"></i>
                              </span>
                           </div>
                           <div class="d-flex flex-column">
                              <small>{{ previous_year }}</small>
                              <h6 class="mb-0">{{ previous_year_events }}</h6>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <!-- Photo Gallery Statistics -->
         <div class="col-12 col-md-12 col-lg-4 mb-4">
            <div class="card bg-primary text-white text-center p-3">
               <figure class="mb-0">
                  <blockquote class="blockquote">
                     <p id="quote-text">Loading quote...</p>
                  </blockquote>
                  <figcaption class="blockquote-footer mb-0 text-white">
                     <span id="quote-author">Unknown</span>
                  </figcaption>
               </figure>
            </div>
            <div class="card mt-4">
               <div class="card-body">
                  <div class="d-flex justify-content-between flex-sm-row flex-column gap-3">
                     <div class="d-flex flex-sm-column flex-row align-items-start justify-content-between">
                        <div class="card-title">
                           <h5 class="text-nowrap mb-2">Photo Gallery</h5>
                           <span class="badge bg-label-warning rounded-pill">Year {{ current_year }}</span>
                        </div>
                        <div class="mt-sm-auto">
                           <small class="text-success text-nowrap fw-semibold">
                           <i class="bx bx-chevron-up"></i> {{ photo_growth }}% </small>
                           <h3 class="mb-0">{{ total_photos }}</h3>
                        </div>
                     </div>
                     <div id="photoReportChart"></div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- Event Types and Popular Events -->
      <div class="row">
         <!-- Event Types Card -->
         <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
               <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="card-title m-0 me-2">Event Types</h5>
               </div>
               <div class="card-body">
                  <ul class="p-0 m-0">
                     {% for event_type, count in top_event_types %} 
                     <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                           <span class="avatar-initial rounded bg-label-primary">
                           <i class="bx bx-calendar"></i>
                           </span>
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                           <div class="me-2">
                              <h6 class="mb-0">{{ event_type }}</h6>
                              <small class="text-muted d-block">{{ count }} events</small>
                           </div>
                           <div class="user-progress">
                              <small class="fw-semibold">{{ count }}</small>
                           </div>
                        </div>
                     </li>
                     {% endfor %} 
                  </ul>
               </div>
            </div>
         </div>
         <!-- Popular Events Card -->
         <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
               <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="card-title m-0 me-2">Popular Events</h5>
                  <div class="dropdown">
                     <button class="btn p-0" type="button" id="popularEvents" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     <i class="bx bx-dots-vertical-rounded"></i>
                     </button>
                     <div class="dropdown-menu dropdown-menu-end" aria-labelledby="popularEvents">
                        <a class="dropdown-item" href="{% url 'events:event_list' %}?sort=popular">View All</a>
                     </div>
                  </div>
               </div>
               <div class="card-body">
                  <ul class="p-0 m-0">
                     {% for event_data in popular_events %} 
                     <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3"> {% if event_data.event.logo %} <img src="{{ event_data.event.logo.url }}" alt="{{ event_data.event.title }}" class="rounded"> {% else %} <span class="avatar-initial rounded bg-label-success">
                           <i class="bx bx-calendar-event"></i>
                           </span> {% endif %} 
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                           <div class="me-2">
                              <h6 class="mb-0">{{ event_data.event.title }}</h6>
                              <small class="text-muted d-block">{{ event_data.event.get_event_type_display }}</small>
                           </div>
                           <div class="user-progress">
                              <small class="fw-semibold">{{ event_data.participant_count }} participants</small>
                           </div>
                        </div>
                     </li>
                     {% endfor %} 
                  </ul>
               </div>
            </div>
         </div>
         <!-- Upcoming Events Card -->
         <div class="col-md-12 col-lg-4 mb-4">
            <div class="card h-100">
               <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="card-title m-0 me-2">Upcoming Events</h5>
                  <div class="dropdown">
                     <button class="btn p-0" type="button" id="upcomingEvents" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     <i class="bx bx-dots-vertical-rounded"></i>
                     </button>
                     <div class="dropdown-menu dropdown-menu-end" aria-labelledby="upcomingEvents">
                        <a class="dropdown-item" href="{% url 'events:event_list' %}?filter=upcoming">View All</a>
                     </div>
                  </div>
               </div>
               <div class="card-body">
                  <ul class="p-0 m-0">
                     {% for event in upcoming_events %} 
                     <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                           <span class="avatar-initial rounded bg-label-warning">
                           <i class="bx bx-calendar-star"></i>
                           </span>
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                           <div class="me-2">
                              <h6 class="mb-0">{{ event.title }}</h6>
                              <small class="text-muted d-block">{{ event.start_date|date:"M d, Y" }}</small>
                           </div>
                           <div class="user-progress">
                              <a href="{% url 'events:event_detail' event.slug %}" class="btn btn-sm btn-outline-primary">View</a>
                           </div>
                        </div>
                     </li>
                     {% endfor %} 
                  </ul>
               </div>
            </div>
         </div>
      </div>
      <!-- Event Management and Access Requests -->
      <div class="row">
         <!-- Event Management -->
         <div class="col-12 mb-4">
            <div class="card">
               <h5 class="card-header m-0 me-2 pb-3">Your Events</h5>
               <div class="table-responsive text-nowrap">
                  <table class="table">
                     <thead>
                        <tr>
                           <th>Event Name</th>
                           <th>Date</th>
                           <th>Type</th>
                           <th>Status</th>
                           <th>Location</th>
                           <th>Actions</th>
                        </tr>
                     </thead>
                     <tbody class="table-border-bottom-0">
                        {% for event in events|slice:":5" %} 
                        <tr>
                           <td>
                              <i class="fab fa-angular fa-lg text-danger me-3"></i>
                              <strong>
                              <a href="{% url 'events:event_dashboard' event.slug %}">{{ event.title }}</a>
                              </strong>
                           </td>
                           <td>{{ event.start_date|date:"M d, Y" }}</td>
                           <td>{{ event.event_type }}</td>
                           <td> {% if event.status == 'DRAFT' %} <span class="badge bg-label-warning me-1">Draft</span> {% elif event.status == 'ACTIVE' %} <span class="badge bg-label-primary me-1">Active</span> {% elif event.status == 'COMPLETED' %} <span class="badge bg-label-success me-1">Completed</span> {% elif event.status == 'CANCELLED' %} <span class="badge bg-label-info me-1">Cancelled</span> {% else %} <span class="badge bg-label-secondary">{{ event.get_status_display }}</span> {% endif %} </td>
                           <td>{{ event.location }}</td>
                           <td>
                              <div class="dropdown">
                                 <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                 <i class="bx bx-dots-vertical-rounded"></i>
                                 </button>
                                 <div class="dropdown-menu">
                                    <a class="dropdown-item" href="{% url 'events:event_dashboard' event.slug %}">
                                    <i class="bx bx-show-alt me-1"></i> View Details </a>
                                    <a class="dropdown-item" href="{% url 'events:event_edit' event.slug %}">
                                    <i class="bx bx-edit-alt me-1"></i> Edit </a>
                                    <a class="dropdown-item" href="{% url 'events:event_participants' event.slug %}">
                                    <i class="bx bx-group me-1"></i> Manage Participants </a>
                                 </div>
                              </div>
                           </td>
                        </tr>
                        {% empty %} 
                        <tr>
                           <td colspan="6" class="text-center">No events created yet</td>
                        </tr>
                        {% endfor %} 
                     </tbody>
                  </table>
                  {% if events.count > 5 %} 
                  <div class="text-center mt-3 mb-3">
                     <a href="{% url 'events:event_list' %}" class="btn btn-sm btn-outline-primary">View All Events</a>
                  </div>
                  {% endif %}
               </div>
            </div>
         </div>
         <!-- Access Requests -->
         <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
               <div class="card-header d-flex align-items-center justify-content-between border-0 bg-transparent">
                  <h5 class="card-title m-0 me-2">Recent Access Requests</h5>
                  <a href="{% url 'events:access_requests' %}" class="btn btn-primary btn-sm rounded-pill">View All</a>
               </div>
               <div class="card-body pt-0">
                  <ul class="list-unstyled p-0 m-0">
                     {% for request in pending_requests|slice:":5" %} 
                     <li class="d-flex mb-3 pb-2 border-bottom">
                        <div class="avatar flex-shrink-0 me-3">
                           {% if request.user.avatar %} <img src="{{ request.user.avatar.url }}" alt="{{ request.user.username }}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" /> {% else %} 
                           <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                              {{ request.user.username|first }}
                           </div>
                           {% endif %} 
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                           <div class="me-2">
                              <small class="text-muted d-block mb-1">{{ request.get_request_type_display }}</small>
                              <h6 class="mb-0">{{ request.user.username }}</h6>
                           </div>
                           <div class="d-flex gap-2">
                              <span class="badge bg-warning text-dark rounded-pill px-3 py-2">Pending</span>
                           </div>
                        </div>
                     </li>
                     {% empty %} 
                     <li class="text-center py-4">
                        <div class="text-muted">
                           <i class="bi bi-inbox mb-2" style="font-size: 2rem;"></i>
                           <p>No pending requests</p>
                        </div>
                     </li>
                     {% endfor %} 
                  </ul>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- / Content -->
<!-- JavaScript for Charts -->
<script>
   document.addEventListener('DOMContentLoaded', function() {
     // Monthly Events Chart
     const eventsChartEl = document.querySelector('#eventsActivityChart');
     const eventChartOptions = {
       series: [
         {
           name: 'Events',
           data: {{ monthly_event_data|safe }}
         }
       ],
       chart: {
         height: 300,
         type: 'bar',
         toolbar: {
           show: false
         }
       },
       plotOptions: {
         bar: {
           horizontal: false,
           columnWidth: '50%',
           borderRadius: 5
         }
       },
       dataLabels: {
         enabled: false
       },
       stroke: {
         curve: 'smooth',
         width: 2
       },
       colors: ['#696cff'],
       grid: {
         borderColor: '#f1f1f1'
       },
       xaxis: {
         categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
         axisBorder: {
           show: false
         },
         axisTicks: {
           show: false
         }
       },
       yaxis: {
         title: {
           text: 'Events',
           style: {
             fontSize: '13px',
             fontFamily: 'Helvetica, Arial, sans-serif'
           }
         }
       },
       tooltip: {
         shared: true,
         intersect: false,
         y: {
           formatter: function (y) {
             if (typeof y !== "undefined") {
               return y.toFixed(0) + " events";
             }
             return y;
           }
         }
       }
     };
     if (eventsChartEl) {
       const eventsChart = new ApexCharts(eventsChartEl, eventChartOptions);
       eventsChart.render();
     }
   
     // Event Growth Chart
     const eventGrowthChartEl = document.querySelector('#eventGrowthChart');
     const eventGrowthChartOptions = {
       series: [{{ event_growth_percentage }}],
       chart: {
         height: 100,
         type: 'radialBar',
         sparkline: {
           enabled: true
         }
       },
       plotOptions: {
         radialBar: {
           hollow: {
             size: '60%'
           },
           track: {
             background: '#eaeaec'
           },
           dataLabels: {
             show: false
           }
         }
       },
       colors: ['#696cff'],
       stroke: {
         lineCap: 'round'
       }
     };
     if (eventGrowthChartEl) {
       const eventGrowthChart = new ApexCharts(eventGrowthChartEl, eventGrowthChartOptions);
       eventGrowthChart.render();
     }
   
     // Photo Report Chart
     const photoReportChartEl = document.querySelector('#photoReportChart');
     const photoReportChartOptions = {
       series: [
         {
           name: 'Photos',
           data: {{ monthly_photo_data|safe }}
         }
       ],
       chart: {
         height: 90,
         type: 'line',
         toolbar: {
           show: false
         },
         sparkline: {
           enabled: true
         }
       },
       grid: {
         show: false
       },
       dataLabels: {
         enabled: false
       },
       stroke: {
         curve: 'smooth',
         width: 2.5
       },
       colors: ['#71dd37'],
       xaxis: {
         categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
         show: false,
         axisBorder: {
           show: false
         },
         axisTicks: {
           show: false
         },
         labels: {
           show: false
         }
       },
       yaxis: {
         show: false
       }
     };
     if (photoReportChartEl) {
       const photoReportChart = new ApexCharts(photoReportChartEl, photoReportChartOptions);
       photoReportChart.render();
     }
   });
   
   // Function to update charts on year change
   function updateChartYear(year) {
     // This would make an AJAX call to get new data for the selected year
     // For now, we'll reload the page with a year parameter
     window.location.href = window.location.pathname + '?year=' + year;
   }
   
   async function fetchQuote() {
     try {
       let response = await fetch("https://qapi.vercel.app/api/random");
       let data = await response.json();
       document.getElementById("quote-text").innerText = data.quote;
       document.getElementById("quote-author").innerText = data.author;
     } catch (error) {
       console.error("Error fetching quote:", error);
     }
   }
   window.onload = fetchQuote;
</script>
{% endblock content %}