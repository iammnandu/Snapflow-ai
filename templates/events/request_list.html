{% extends "users/db_base.html" %}
{% load static %}
{% block title %}Access Requests - Event Management{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">Events /</span> Access Requests
  </h4>

  <!-- Tab navigation based on user roles -->
  {% if is_organizer or is_photographer or is_participant %}
  <ul class="nav nav-tabs mb-4" role="tablist">
    {% if is_organizer %}
    <li class="nav-item">
      <button 
        class="nav-link {% if is_organizer %}active{% endif %}" 
        data-bs-toggle="tab" 
        data-bs-target="#organizer-tab" 
        type="button" 
        role="tab" 
        aria-controls="organizer-tab" 
        aria-selected="{% if is_organizer %}true{% else %}false{% endif %}"
      >
        <i class="bx bx-calendar-event me-1"></i> My Events
      </button>
    </li>
    {% endif %}
    
    {% if is_photographer %}
    <li class="nav-item">
      <button 
        class="nav-link {% if not is_organizer and is_photographer %}active{% endif %}" 
        data-bs-toggle="tab" 
        data-bs-target="#photographer-tab" 
        type="button" 
        role="tab" 
        aria-controls="photographer-tab" 
        aria-selected="{% if not is_organizer and is_photographer %}true{% else %}false{% endif %}"
      >
        <i class="bx bx-camera me-1"></i> Photographer Requests
      </button>
    </li>
    {% endif %}
    
    {% if is_participant %}
    <li class="nav-item">
      <button 
        class="nav-link {% if not is_organizer and not is_photographer and is_participant %}active{% endif %}" 
        data-bs-toggle="tab" 
        data-bs-target="#participant-tab" 
        type="button" 
        role="tab" 
        aria-controls="participant-tab" 
        aria-selected="{% if not is_organizer and not is_photographer and is_participant %}true{% else %}false{% endif %}"
      >
        <i class="bx bx-user me-1"></i> Participant Requests
      </button>
    </li>
    {% endif %}
  </ul>
  {% endif %}
  
  <div class="tab-content">
    {% if is_organizer %}
    <!-- ORGANIZER TAB -->
    <div class="tab-pane fade {% if is_organizer %}show active{% endif %}" id="organizer-tab" role="tabpanel">
      <!-- Pending Requests -->
      <h5 class="pb-1 mb-4">Pending Requests</h5>
      <div class="row mb-5">
        {% for request in organized_requests %}
        {% if request.status == 'PENDING' %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="row g-0">
              <div class="col-md-4 d-flex align-items-center justify-content-center p-3">
                <div class="avatar-wrapper" style="width: 100px; height: 100px; overflow: hidden; border-radius: 50%; flex-shrink: 0;">
                  {% if request.user.avatar %}
                  <img 
                    src="{{ request.user.avatar.url }}" 
                    alt="{{ request.user.username }}" 
                    style="width: 100%; height: 100%; object-fit: cover;"
                  />
                  {% else %}
                  <div 
                    class="avatar-initial d-flex align-items-center justify-content-center bg-label-primary"
                    style="width: 100%; height: 100%; font-size: 2.5rem;"
                  >
                    {{ request.user.username|first|upper }}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">{{ request.user.get_full_name|default:request.user.username }}</h5>
                    <span class="badge bg-label-warning">{{ request.get_request_type_display }}</span>
                  </div>
                  <p class="card-text">{{ request.message|truncatechars:100 }}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <p class="card-text"><small class="text-muted">Requested {{ request.created_at|timesince }} ago</small></p>
                    <div>
                      <button 
                        class="btn btn-outline-primary btn-sm me-2" 
                        type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#userDetails{{ request.id }}"
                        aria-controls="userDetails{{ request.id }}"
                      >
                        <i class="bx bx-user me-1"></i>User Details
                      </button>
                      <div class="btn-group">
                        <form method="POST" action="{% url 'events:approve_request' request.id %}" class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-success btn-sm me-2">Approve</button>
                        </form>
                        <form method="POST" action="{% url 'events:reject_request' request.id %}" class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Offcanvas for User Details -->
        <div 
          class="offcanvas offcanvas-end" 
          tabindex="-1" 
          id="userDetails{{ request.id }}" 
          aria-labelledby="userDetailsLabel{{ request.id }}"
        >
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="userDetailsLabel{{ request.id }}">User Profile</h5>
            <button 
              type="button" 
              class="btn-close text-reset" 
              data-bs-dismiss="offcanvas" 
              aria-label="Close"
            ></button>
          </div>
          <div class="offcanvas-body">
            <div class="text-center mb-4">
              {% if request.user.avatar %}
              <img 
                src="{{ request.user.avatar.url }}" 
                alt="{{ request.user.username }}" 
                class="rounded-circle"
                width="120"
                height="120"
                style="object-fit: cover;"
              />
              {% else %}
              <div 
                class="avatar-initial d-flex align-items-center justify-content-center bg-label-primary rounded-circle mx-auto"
                style="width: 120px; height: 120px; font-size: 3rem;"
              >
                {{ request.user.username|first|upper }}
              </div>
              {% endif %}
              <h4 class="mt-3">{{ request.user.get_full_name|default:request.user.username }}</h4>
              <p class="text-muted">@{{ request.user.username }}</p>
            </div>
            
            <div class="mb-4">
              <h6 class="fw-bold">Personal Information</h6>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Full Name:</div>
                    <div class="col-7">{{ request.user.get_full_name|default:"Not provided" }}</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Email:</div>
                    <div class="col-7">{{ request.user.email }}</div>
                  </div>
                  {% if request.user.phone %}
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Phone:</div>
                    <div class="col-7">{{ request.user.phone }}</div>
                  </div>
                  {% endif %}
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Member Since:</div>
                    <div class="col-7">{{ request.user.date_joined|date:"F j, Y" }}</div>
                  </div>
                  {% if request.user.bio %}
                  <div class="row">
                    <div class="col-12 fw-semibold">Bio:</div>
                    <div class="col-12 mt-1">{{ request.user.bio }}</div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="mb-4">
              <h6 class="fw-bold">Request Details</h6>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Request Type:</div>
                    <div class="col-7">
                      <span class="badge bg-label-warning">{{ request.get_request_type_display }}</span>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Event:</div>
                    <div class="col-7">{{ request.event.title }}</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Requested:</div>
                    <div class="col-7">{{ request.created_at|date:"F j, Y - H:i" }}</div>
                  </div>
                  <div class="row">
                    <div class="col-12 fw-semibold">Message:</div>
                    <div class="col-12 mt-1">{{ request.message }}</div>
                  </div>
                </div>
              </div>
            </div>
            
            {% if request.user.portfolio_url or request.user.social_links %}
            <div class="mb-4">
              <h6 class="fw-bold">Portfolio & Social Media</h6>
              <div class="card">
                <div class="card-body">
                  {% if request.user.portfolio_url %}
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Portfolio:</div>
                    <div class="col-7">
                      <a href="{{ request.user.portfolio_url }}" target="_blank">
                        {{ request.user.portfolio_url }}
                        <i class="bx bx-link-external ms-1"></i>
                      </a>
                    </div>
                  </div>
                  {% endif %}
                  
                  {% if request.user.social_links %}
                  <div class="row">
                    <div class="col-5 fw-semibold">Social Media:</div>
                    <div class="col-7">
                      {% for platform, link in request.user.social_links.items %}
                      <div>
                        <i class="bx bxl-{{ platform|lower }} me-1"></i>
                        <a href="{{ link }}" target="_blank">{{ platform }}</a>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            
            <div class="d-grid gap-2">
              <div class="row">
                <div class="col-6">
                  <form method="POST" action="{% url 'events:approve_request' request.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success w-100">
                      <i class="bx bx-check me-1"></i>Approve Request
                    </button>
                  </form>
                </div>
                <div class="col-6">
                  <form method="POST" action="{% url 'events:reject_request' request.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100">
                      <i class="bx bx-x me-1"></i>Reject Request
                    </button>
                  </form>
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-outline-secondary" 
                data-bs-dismiss="offcanvas"
              >
                Close
              </button>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
        
        {% if not organized_requests or not organized_requests|dictsortreversed:"status"|dictsort:"status.0" %}
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bx bx-info-circle fs-1 text-muted mb-2"></i>
              <p class="mb-0">No pending requests at the moment.</p>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Past Requests -->
      <h5 class="pb-1 mb-4">Past Requests</h5>
      <div class="row mb-5">
        {% for request in organized_requests %}
        {% if request.status != 'PENDING' %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="row g-0">
              <div class="col-md-4 d-flex align-items-center justify-content-center p-3">
                <div class="avatar-wrapper" style="width: 100px; height: 100px; overflow: hidden; border-radius: 50%; flex-shrink: 0;">
                  {% if request.user.avatar %}
                  <img 
                    src="{{ request.user.avatar.url }}" 
                    alt="{{ request.user.username }}" 
                    style="width: 100%; height: 100%; object-fit: cover;"
                  />
                  {% else %}
                  <div 
                    class="avatar-initial d-flex align-items-center justify-content-center bg-label-primary"
                    style="width: 100%; height: 100%; font-size: 2.5rem;"
                  >
                    {{ request.user.username|first|upper }}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">{{ request.user.get_full_name|default:request.user.username }}</h5>
                    <span class="badge {% if request.status == 'APPROVED' %}bg-label-success{% else %}bg-label-danger{% endif %}">
                      {{ request.get_status_display }}
                    </span>
                  </div>
                  <p class="card-text">{{ request.message|truncatechars:100 }}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <p class="card-text">
                      <small class="text-muted">{{ request.get_request_type_display }} • Updated {{ request.updated_at|timesince }} ago</small>
                    </p>
                    <button 
                      class="btn btn-outline-primary btn-sm" 
                      type="button"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#userDetails{{ request.id }}"
                      aria-controls="userDetails{{ request.id }}"
                    >
                      <i class="bx bx-user me-1"></i>User Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Offcanvas for User Details (Past Requests) -->
        <div 
          class="offcanvas offcanvas-end" 
          tabindex="-1" 
          id="userDetails{{ request.id }}" 
          aria-labelledby="userDetailsLabel{{ request.id }}"
        >
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="userDetailsLabel{{ request.id }}">User Profile</h5>
            <button 
              type="button" 
              class="btn-close text-reset" 
              data-bs-dismiss="offcanvas" 
              aria-label="Close"
            ></button>
          </div>
          <div class="offcanvas-body">
            <!-- Offcanvas content same as above -->
            <div class="text-center mb-4">
              {% if request.user.avatar %}
              <img 
                src="{{ request.user.avatar.url }}" 
                alt="{{ request.user.username }}" 
                class="rounded-circle"
                width="120"
                height="120"
                style="object-fit: cover;"
              />
              {% else %}
              <div 
                class="avatar-initial d-flex align-items-center justify-content-center bg-label-primary rounded-circle mx-auto"
                style="width: 120px; height: 120px; font-size: 3rem;"
              >
                {{ request.user.username|first|upper }}
              </div>
              {% endif %}
              <h4 class="mt-3">{{ request.user.get_full_name|default:request.user.username }}</h4>
              <p class="text-muted">@{{ request.user.username }}</p>
            </div>
            
            <!-- Rest of offcanvas content -->
            <div class="mb-4">
              <h6 class="fw-bold">Personal Information</h6>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Full Name:</div>
                    <div class="col-7">{{ request.user.get_full_name|default:"Not provided" }}</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Email:</div>
                    <div class="col-7">{{ request.user.email }}</div>
                  </div>
                  {% if request.user.phone %}
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Phone:</div>
                    <div class="col-7">{{ request.user.phone }}</div>
                  </div>
                  {% endif %}
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Member Since:</div>
                    <div class="col-7">{{ request.user.date_joined|date:"F j, Y" }}</div>
                  </div>
                  {% if request.user.bio %}
                  <div class="row">
                    <div class="col-12 fw-semibold">Bio:</div>
                    <div class="col-12 mt-1">{{ request.user.bio }}</div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="mb-4">
              <h6 class="fw-bold">Request Details</h6>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Request Type:</div>
                    <div class="col-7">
                      <span class="badge {% if request.status == 'APPROVED' %}bg-label-success{% else %}bg-label-danger{% endif %}">
                        {{ request.get_status_display }}
                      </span>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Event:</div>
                    <div class="col-7">{{ request.event.title }}</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Requested:</div>
                    <div class="col-7">{{ request.created_at|date:"F j, Y - H:i" }}</div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-5 fw-semibold">Updated:</div>
                    <div class="col-7">{{ request.updated_at|date:"F j, Y - H:i" }}</div>
                  </div>
                  <div class="row">
                    <div class="col-12 fw-semibold">Message:</div>
                    <div class="col-12 mt-1">{{ request.message }}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <button 
              type="button" 
              class="btn btn-outline-secondary w-100" 
              data-bs-dismiss="offcanvas"
            >
              Close
            </button>
          </div>
        </div>
        {% endif %}
        {% endfor %}
        
        {% if not organized_requests or organized_requests|length == 0 or organized_requests|dictsort:"status.0"|length == 0 %}
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bx bx-info-circle fs-1 text-muted mb-2"></i>
              <p class="mb-0">No past requests to display.</p>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    {% if is_photographer %}
    <!-- PHOTOGRAPHER TAB -->
    <div class="tab-pane fade {% if not is_organizer and is_photographer %}show active{% endif %}" id="photographer-tab" role="tabpanel">
      <h5 class="pb-1 mb-4">My Photography Requests</h5>
      <div class="row">
        {% for request in photographer_requests %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">{{ request.event.title }}</h5>
              <span class="badge {% if request.status == 'PENDING' %}bg-label-warning{% elif request.status == 'APPROVED' %}bg-label-success{% else %}bg-label-danger{% endif %}">
                {{ request.get_status_display }}
              </span>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="d-flex align-items-center mb-2">
                  <i class="bx bx-calendar me-2 text-muted"></i>
                  <span>{{ request.event.start_date|date:"M d, Y" }} - {{ request.event.end_date|date:"M d, Y" }}</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <i class="bx bx-map me-2 text-muted"></i>
                  <span>{{ request.event.location }}</span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="bx bx-user me-2 text-muted"></i>
                  <span>Organizer: {{ request.event.organizer.get_full_name|default:request.event.organizer.username }}</span>
                </div>
              </div>
              <div class="card bg-light mb-3">
                <div class="card-body py-2">
                  <small class="text-muted">Your message:</small>
                  <p class="mb-0">{{ request.message }}</p>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Requested {{ request.created_at|timesince }} ago</small>
                <div>
                  {% if request.status == 'APPROVED' %}
                  <a href="{% url 'events:event_detail' request.event.slug %}" class="btn btn-primary btn-sm">
                    <i class="bx bx-calendar-event me-1"></i>View Event
                  </a>
                  {% elif request.status == 'PENDING' %}
                  <form method="POST" action="{% url 'events:cancel_access_request' request.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="bx bx-x me-1"></i>Cancel Request
                    </button>
                  </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bx bx-camera fs-1 text-muted mb-2"></i>
              <p class="mb-3">You haven't made any photography requests yet.</p>
              <a href="{% url 'events:event_list' %}" class="btn btn-primary">
                <i class="bx bx-search me-1"></i>Browse Events
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    {% if is_participant %}
    <!-- PARTICIPANT TAB -->
    <div class="tab-pane fade {% if not is_organizer and not is_photographer and is_participant %}show active{% endif %}" id="participant-tab" role="tabpanel">
      <h5 class="pb-1 mb-4">My Participation Requests</h5>
      <div class="row">
        {% for request in participant_requests %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">{{ request.event.title }}</h5>
              <span class="badge {% if request.status == 'PENDING' %}bg-label-warning{% elif request.status == 'APPROVED' %}bg-label-success{% else %}bg-label-danger{% endif %}">
                {{ request.get_status_display }}
              </span>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="d-flex align-items-center mb-2">
                  <i class="bx bx-calendar me-2 text-muted"></i>
                  <span>{{ request.event.start_date|date:"M d, Y" }} - {{ request.event.end_date|date:"M d, Y" }}</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <i class="bx bx-map me-2 text-muted"></i>
                  <span>{{ request.event.location }}</span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="bx bx-user me-2 text-muted"></i>
                  <span>Organizer: {{ request.event.organizer.get_full_name|default:request.event.organizer.username }}</span>
                </div>
              </div>
              <div class="card bg-light mb-3">
                <div class="card-body py-2">
                  <small class="text-muted">Your message:</small>
                  <p class="mb-0">{{ request.message }}</p>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Requested {{ request.created_at|timesince }} ago</small>
                <div>
                  {% if request.status == 'APPROVED' %}
                  <a href="{% url 'events:event_detail' request.event.id %}" class="btn btn-primary btn-sm">
                    <i class="bx bx-calendar-event me-1"></i>View Event
                  </a>
                  {% elif request.status == 'PENDING' %}
                  <form method="POST" action="{% url 'events:cancel_request' request.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="bx bx-x me-1"></i>Cancel Request
                    </button>
                  </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bx bx-user-plus fs-1 text-muted mb-2"></i>
              <p class="mb-3">You haven't made any participation requests yet.</p>
              <a href="{% url 'events:event_list' %}" class="btn btn-primary">
                <i class="bx bx-search me-1"></i>Browse Events
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}