<!-- photos/templates/photos/photo_detail.html -->
{% extends "users/db_base.html" %}
{% load static %}

{% block title %}{{ photo.caption|default:"Photo" }} | {{ event.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="mb-4">
        <a href="{% url 'photos:event_gallery' slug=event.slug %}" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i>Back to Gallery
        </a>
    </div>
    
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="md:flex">
            <!-- Photo Container -->
            <div class="md:w-3/4 relative bg-black">
                <div class="relative photo-container">
                    {% if has_enhanced_version and photo.enhanced_image %}
                        <img id="displayedImage" src="{{ photo.enhanced_image.url }}" alt="{{ photo.caption|default:'Event photo' }}" class="w-full h-auto mx-auto">
                        <div class="absolute top-0 right-0 m-4">
                            <button id="toggleEnhanced" class="px-3 py-1 bg-black/70 text-white rounded text-sm flex items-center">
                                <span id="enhancedStatus">Enhanced</span>
                                <i class="fas fa-toggle-on ml-2"></i>
                            </button>
                        </div>
                    {% else %}
                        <img src="{{ photo.image.url }}" alt="{{ photo.caption|default:'Event photo' }}" class="w-full h-auto mx-auto">
                    {% endif %}
                </div>
                
                <!-- Navigation between photos (previous/next) could go here -->
            </div>
            
            <!-- Photo Information -->
            <div class="md:w-1/4 p-4 border-l">
                <div class="mb-4 pb-4 border-b">
                    <h1 class="text-xl font-bold mb-2">{{ photo.caption|default:"Photo" }}</h1>
                    <p class="text-gray-600 text-sm mb-2">
                        Uploaded by {{ photo.uploaded_by.get_full_name|default:photo.uploaded_by.username }}
                        on {{ photo.upload_date|date:"F d, Y" }}
                    </p>
                    
                    <!-- AI Quality Score -->
                    {% if photo.quality_score %}
                    <div class="mb-2">
                        <div class="flex items-center">
                            <span class="text-sm mr-2">Quality:</span>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ photo.quality_score|floatformat:0 }}%"></div>
                            </div>
                            <span class="ml-2 text-sm">{{ photo.quality_score|floatformat:1 }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Photo Stats -->
                    <div class="flex space-x-4 mt-2">
                        <div class="flex items-center">
                            <i class="far fa-eye text-gray-500 mr-1"></i>
                            <span class="text-sm">{{ photo.view_count }}</span>
                        </div>
                        
                        <!-- Like button -->
                        <div class="flex items-center">
                            <button id="likeButton" class="flex items-center focus:outline-none"
                                    data-photo-id="{{ photo.id }}" 
                                    data-liked="{% if user_liked %}true{% else %}false{% endif %}">
                                <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-heart mr-1 {% if user_liked %}text-red-500{% else %}text-gray-500{% endif %}"></i>
                                <span id="likeCount" class="text-sm">{{ photo.like_count }}</span>
                            </button>
                        </div>
                        
                        <!-- Download button -->
                        {% if can_download %}
                        <div>
                            <a href="{{ photo.image.url }}" download class="flex items-center text-gray-500 hover:text-gray-700">
                                <i class="fas fa-download mr-1"></i>
                                <span class="text-sm">Download</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- AI-Generated Tags -->
                {% if scene_tags %}
                <div class="mb-4 pb-4 border-b">
                    <h3 class="text-md font-semibold mb-2">Tags</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in scene_tags %}
                            <a href="{% url 'photos:event_gallery' slug=event.slug %}?tag={{ tag }}" 
                               class="px-2 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300">
                                {{ tag|capfirst }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Recognized People -->
                {% if recognized_users %}
                <div class="mb-4 pb-4 border-b">
                    <h3 class="text-md font-semibold mb-2">People in this Photo</h3>
                    <div class="space-y-2">
                        {% for person in recognized_users %}
                            <div class="flex items-center">
                                {% if person.user.profile_picture %}
                                    <img src="{{ person.user.profile_picture.url }}" alt="{{ person.user.get_full_name }}" 
                                         class="w-8 h-8 rounded-full mr-2 object-cover">
                                {% else %}
                                    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                        <span class="text-xs text-gray-600">
                                            {{ person.user.get_initials|default:person.user.username|slice:":2"|upper }}
                                        </span>
                                    </div>
                                {% endif %}
                                <div>
                                    <p class="text-sm font-medium">{{ person.user.get_full_name|default:person.user.username }}</p>
                                    <p class="text-xs text-gray-500">{{ person.confidence|floatformat:1 }}% match</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Comments Section -->
                <div id="comments-section">
                    <h3 class="text-md font-semibold mb-2">Comments</h3>
                    
                    <!-- Comment Form -->
                    {% if event.configuration.enable_comments and user.is_authenticated %}
                    <form id="commentForm" class="mb-4">
                        <textarea id="commentText" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  rows="2" placeholder="Add a comment..."></textarea>
                        <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Post</button>
                    </form>
                    {% endif %}
                    
                    <!-- Comments List -->
                    <div id="commentsList" class="space-y-3">
                        <div class="text-center py-4 text-sm text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Loading comments...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle between original and enhanced image
    const toggleEnhanced = document.getElementById('toggleEnhanced');
    const displayedImage = document.getElementById('displayedImage');
    const enhancedStatus = document.getElementById('enhancedStatus');
    
    if (toggleEnhanced) {
        let showingEnhanced = true;
        const originalSrc = "{{ photo.image.url }}";
        {% if photo.enhanced_image %}
            const enhancedSrc = "{{ photo.enhanced_image.url }}";
        {% else %}
            const enhancedSrc = null;
        {% endif %}

        toggleEnhanced.addEventListener('click', function() {
            if (showingEnhanced && enhancedSrc) {
                displayedImage.src = enhancedSrc;
                enhancedStatus.textContent = "Enhanced";
                toggleEnhanced.querySelector('i').classList.remove('fa-toggle-off');
                toggleEnhanced.querySelector('i').classList.add('fa-toggle-on');
            } else {
                displayedImage.src = originalSrc;
                enhancedStatus.textContent = "Original";
                toggleEnhanced.querySelector('i').classList.remove('fa-toggle-on');
                toggleEnhanced.querySelector('i').classList.add('fa-toggle-off');
            }
            showingEnhanced = !showingEnhanced;
        });

        // Disable toggle button if no enhanced image exists
        if (!enhancedSrc) {
            toggleEnhanced.disabled = true;
            toggleEnhanced.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    // Like functionality
    const likeButton = document.getElementById('likeButton');
    if (likeButton) {
        likeButton.addEventListener('click', function() {
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                window.location.href = "{% url 'users:login' %}?next={{ request.path }}";
                return;
            }
            
            const photoId = this.dataset.photoId;
            
            fetch(`/photos/photo/${photoId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'action=like'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('likeCount').textContent = data.like_count;
                    
                    if (data.liked) {
                        likeButton.querySelector('i').classList.remove('far');
                        likeButton.querySelector('i').classList.add('fas', 'text-red-500');
                    } else {
                        likeButton.querySelector('i').classList.remove('fas', 'text-red-500');
                        likeButton.querySelector('i').classList.add('far');
                    }
                    
                    likeButton.dataset.liked = data.liked ? 'true' : 'false';
                }
            });
        });
    }
    
    // Load comments
    function loadComments() {
        const commentsList = document.getElementById('commentsList');
        
        fetch(`/photos/photo/{{ photo.id }}/comments/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (data.comments.length > 0) {
                    commentsList.innerHTML = '';
                    
                    data.comments.forEach(comment => {
                        let profilePic = '';
                        
                        if (comment.profile_picture) {
                            profilePic = `<img src="${comment.profile_picture}" alt="${comment.user_name}" class="w-8 h-8 rounded-full object-cover">`;
                        } else if (comment.user_initials) {
                            profilePic = `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                                            <span class="text-xs text-gray-600">${comment.user_initials}</span>
                                          </div>`;
                        } else {
                            profilePic = `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                                            <i class="fas fa-user text-gray-400"></i>
                                          </div>`;
                        }
                        
                        let deleteButton = '';
                        if (comment.can_delete) {
                            deleteButton = `<button class="text-xs text-red-500 hover:text-red-700 delete-comment" data-comment-id="${comment.id}">
                                              Delete
                                            </button>`;
                        }
                        
                        const commentHtml = `
                            <div class="comment" data-comment-id="${comment.id}">
                                <div class="flex">
                                    <div class="mr-3 flex-shrink-0">
                                        ${profilePic}
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex justify-between">
                                            <p class="font-medium text-sm">${comment.user_name}</p>
                                            <div class="text-xs text-gray-500 flex items-center">
                                                <span>${comment.created_at}</span>
                                                ${deleteButton}
                                            </div>
                                        </div>
                                        <p class="text-sm mt-1">${comment.comment}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        commentsList.innerHTML += commentHtml;
                    });
                    
                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-comment').forEach(button => {
                        button.addEventListener('click', function() {
                            const commentId = this.dataset.commentId;
                            deleteComment(commentId);
                        });
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-center py-4 text-sm text-gray-500">No comments yet. Be the first to comment!</p>';
                }
            }
        })
        .catch(error => {
            commentsList.innerHTML = '<p class="text-center py-4 text-sm text-red-500">Error loading comments. Please try again.</p>';
            console.error('Error loading comments:', error);
        });
    }
    
    // Add comment
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const commentText = document.getElementById('commentText').value.trim();
            if (!commentText) return;
            
            fetch(`/photos/photo/{{ photo.id }}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `action=comment&comment=${encodeURIComponent(commentText)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('commentText').value = '';
                    loadComments();
                }
            });
        });
    }
    
    // Delete comment function
    function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;
        
        fetch(`/photos/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadComments();
            }
        });
    }
    
    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Load comments on page load
    loadComments();
});
</script>
{% endblock %}